name: Pull Alpine BaseOS Container

on:
  push:
    branches: ["main"]
    paths:
      - docker-images/blob/main/.github/workflows/alpine/last_version.txt

  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ‚è¨ Download Alpine MinirootFS
        run: |
          URL_BASE="https://dl-cdn.alpinelinux.org/alpine/v3.20/releases/x86_64/"
          OS_VERSION="alpine-minirootfs"
          EXT=".tar.gz"
          LAST_VERSION=$(curl -s https://raw.githubusercontent.com/AtomyCloud/docker-images/main/.github/workflows/alpine/last_version.txt | tail -n 1)
          URL="${URL_BASE}${OS_VERSION}-${LAST_VERSION}-x86_64${EXT}"

          curl -L -o $OS_VERSION-$LAST_VERSION-x86_64-$EXT $URL

      - name: üÜï Import Docker Image && Tag Docker Image
        run: |
          docker image import $OS_VERSION-$LAST_VERSION-x86_64-$EXT atomycloud/os:$OS_VERSION-$LAST_VERSION-x86_64-$EXT

      - name: üîíÔ∏è DockerHub Login
        uses: docker/login-action@v3.0.0
        with:
         username: ${{secrets.DOCKERHUB_USER}}
         password: ${{secrets.DOCKERHUB_PWD}}

      - name: üÜó Push Docker Image
        run: |
          docker push atomycloud/os:$OS_VERSION-$LAST_VERSION-x86_64-$EXT
